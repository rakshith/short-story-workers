name = "create-story-worker"
main = "src/index.ts"
compatibility_date = "2024-11-06"
compatibility_flags = ["nodejs_compat"]
workers_dev = true
preview_urls = true

# Durable Objects
[durable_objects]
bindings = [
  { name = "STORY_COORDINATOR", class_name = "StoryCoordinator" }
]

[[migrations]]
tag = "v1"
new_classes = ["StoryCoordinator"]

[env.staging]
name = "create-story-worker-staging"
workers_dev = true
preview_urls = true

# Durable Objects for staging
[env.staging.durable_objects]
bindings = [
  { name = "STORY_COORDINATOR", class_name = "StoryCoordinator" }
]

# R2 Bucket bindings for staging
[[env.staging.r2_buckets]]
binding = "IMAGES_BUCKET"
bucket_name = "images"
preview_bucket_name = "images"

[[env.staging.r2_buckets]]
binding = "AUDIO_BUCKET"
bucket_name = "audio"
preview_bucket_name = "audio"

[[env.staging.r2_buckets]]
binding = "VIDEO_BUCKET"
bucket_name = "videos"
preview_bucket_name = "videos"

# Queue for async processing in staging
# Note: Tier-based concurrency is managed in code via concurrency-manager.ts
# These settings are baseline - actual concurrency per user is controlled by tier
[[env.staging.queues.producers]]
queue = "story-processing-staging"
binding = "STORY_QUEUE"

[[env.staging.queues.consumers]]
queue = "story-processing-staging"
max_batch_size = 15           # Supports up to tier4 batch size
max_batch_timeout = 20        # Process every 20 seconds or when batch fills
max_concurrency = 20          # Overall worker concurrency (tier limits applied in code)

[env.production]
name = "create-story-worker-production"
workers_dev = true
preview_urls = true

# Durable Objects for production
[env.production.durable_objects]
bindings = [
  { name = "STORY_COORDINATOR", class_name = "StoryCoordinator" }
]

# R2 Bucket bindings for production
[[env.production.r2_buckets]]
binding = "IMAGES_BUCKET"
bucket_name = "images"
preview_bucket_name = "images"

[[env.production.r2_buckets]]
binding = "AUDIO_BUCKET"
bucket_name = "audio"
preview_bucket_name = "audio"

[[env.production.r2_buckets]]
binding = "VIDEO_BUCKET"
bucket_name = "videos"
preview_bucket_name = "videos"

# Queue for async processing in production
# Note: Tier-based concurrency is managed in code via concurrency-manager.ts
# These settings are baseline - actual concurrency per user is controlled by tier
[[env.production.queues.producers]]
queue = "story-processing-production"
binding = "STORY_QUEUE"

[[env.production.queues.consumers]]
queue = "story-processing-production"
max_batch_size = 15           # Supports up to tier4 batch size
max_batch_timeout = 20        # Process every 20 seconds or when batch fills
max_concurrency = 20          # Overall worker concurrency (tier limits applied in code)

# Environment variables (set via wrangler secret put or dashboard)
# SUPABASE_URL
# SUPABASE_ANON_KEY
# SUPABASE_SERVICE_ROLE_KEY
# REPLICATE_API_TOKEN
# OPENAI_API_KEY
# ELEVENLABS_API_KEY
# ELEVENLABS_DEFAULT_VOICE_ID
# ELEVENLABS_MODEL_ID

